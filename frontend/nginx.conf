# Case-insensitive WebSocket upgrade detection for Bolt proxy
map $http_upgrade $is_websocket {
    default       "";
    ~*websocket   "true";
}

server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # IPFS: Kubo RPC at /api/v0/ (must be BEFORE /api/ to take priority)
    # The IPFS Web UI auto-detects the RPC at same-origin /api/v0/
    location ^~ /api/v0/ {
        proxy_pass http://ipfs:5001/api/v0/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Kubo checks Origin AND Referer against allowlist - both must pass
        # Set Origin to Kubo's own address (in default allowlist) and strip Referer
        proxy_set_header Origin "http://127.0.0.1:5001";
        proxy_set_header Referer "";

        # CRITICAL: Streaming support for ndjson endpoints (stats/bw, log/tail)
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_http_version 1.1;
        chunked_transfer_encoding on;

        # Only set Connection header on WebSocket upgrade, not on every request
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $http_connection;

        # Allow iframe embedding
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;

        # CORS (Kubo only sends CORS when Origin header is present)
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;

        if ($request_method = OPTIONS) {
            return 204;
        }

        # Long timeouts for streaming endpoints
        proxy_read_timeout 600s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
    }

    # API proxy to backend
    location /api/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts for long-running requests
        proxy_read_timeout 300s;
        proxy_connect_timeout 60s;
    }

    # n8n: strip /n8n/ prefix - all n8n routes (assets, API, WebSocket) run without prefix internally
    location ^~ /n8n/ {
        proxy_pass http://n8n:5678/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (n8n editor uses WebSockets)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Allow iframe embedding
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;

        # Large buffers for n8n assets (JS/CSS bundles)
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        # Timeouts
        proxy_read_timeout 300s;
        proxy_connect_timeout 60s;
    }

    # Neo4j: proxy entire HTTP API (Browser UI + discovery endpoint)
    # /neo4j/* -> neo4j:7474/* (includes /browser/, discovery at /, and all assets)
    location ^~ /neo4j/ {
        proxy_pass http://neo4j:7474/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Allow iframe embedding
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;

        # Large buffers for Neo4j Browser assets (JS/CSS bundles)
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        # Timeouts
        proxy_read_timeout 300s;
        proxy_connect_timeout 60s;
    }

    # IPFS: Kubo RPC proxy for initial /webui/ redirect
    location ^~ /ipfs-rpc/ {
        proxy_pass http://ipfs:5001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
    }

    # SPA route /ipfs and /ipfs/ must serve the React app, not the gateway
    # Exact match (=) has higher priority than prefix match (^~)
    location = /ipfs {
        try_files /index.html =404;
    }
    location = /ipfs/ {
        try_files /index.html =404;
    }

    # IPFS: Public Gateway (fetch content by CID: /ipfs/<CID>/...)
    location ^~ /ipfs/ {
        proxy_pass http://ipfs:8080/ipfs/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # Allow iframe embedding
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;

        # Some IPFS content can be large
        proxy_read_timeout 120s;
        proxy_buffering off;
    }

    # Internal location for Bolt WebSocket proxy (Neo4j Browser connects here)
    location @bolt {
        proxy_pass http://neo4j:7687;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # Bolt connections can be long-lived
        proxy_read_timeout 86400s;
        proxy_connect_timeout 60s;
    }

    # SPA fallback + Bolt WebSocket routing
    # Neo4j Browser connects Bolt via ws://localhost:3000/ (advertised address)
    # Regular HTTP requests serve the React SPA as usual
    location / {
        # Route Bolt WebSocket upgrades to Neo4j (rewrite inside if is safe in nginx)
        error_page 418 = @bolt;
        if ($is_websocket = "true") {
            return 418;
        }

        try_files $uri $uri/ /index.html;
    }

    # Static assets caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Health check
    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript image/svg+xml;
}
